<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SoundKey - 触发式音效板</title>
    <style>
        :root {
            --background: #ffffff;
            --foreground: #09090b;
            --muted: #f4f4f5;
            --muted-foreground: #71717a;
            --card: #ffffff;
            --border: #e4e4e7;
            --input: #e4e4e7;
            --primary: #18181b;
            --primary-foreground: #fafafa;
            --secondary: #f4f4f5;
            --destructive: #ef4444;
            --ring: #18181b;
            --radius: 0.5rem;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        }

        body {
            background-color: #fafafa;
            color: var(--foreground);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            display: flex;
            justify-content: center;
            padding: 40px 20px;
            margin: 0;
            min-height: 100vh;
        }

        .card {
            background-color: var(--card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            box-shadow: var(--shadow-sm);
            width: 100%;
            max-width: 550px;
            display: flex;
            flex-direction: column;
        }

        .card-header {
            padding: 24px;
            border-bottom: 1px solid var(--border);
        }

        .card-title {
            margin: 0;
            font-size: 24px;
            font-weight: 600;
            letter-spacing: -0.025em;
        }

        .card-description {
            margin: 6px 0 0 0;
            font-size: 14px;
            color: var(--muted-foreground);
        }

        .card-content {
            padding: 24px;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        #list-container {
            list-style: none;
            padding: 0;
            margin: 0;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .sound-item {
            display: flex;
            align-items: center;
            padding: 12px;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            background-color: var(--card);
            transition: all 0.2s ease;
            gap: 12px;
        }

        /* 播放时的发光效果 */
        .sound-item.active-playing {
            border-color: #10b981;
            box-shadow: 0 0 0 2px rgba(16, 185, 129, 0.1);
            background-color: #f0fdf4;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border-radius: calc(var(--radius) - 2px);
            font-size: 14px;
            font-weight: 500;
            height: 40px;
            padding: 0 16px;
            cursor: pointer;
            transition: all 0.15s ease;
            border: 1px solid transparent;
        }

        .btn-primary { background-color: var(--primary); color: var(--primary-foreground); }
        .btn-outline { background-color: transparent; border-color: var(--border); }
        .btn-outline:hover { background-color: var(--secondary); }
        .btn-ghost:hover { background-color: var(--secondary); color: var(--destructive); }

        .btn-record { width: 40px; padding: 0; border-radius: 50%; }
        .btn-record.recording { background-color: var(--destructive); color: white; animation: pulse-red 1.5s infinite; }
        .btn-record.has-audio { border-color: #10b981; color: #10b981; }

        .input-key {
            height: 36px;
            width: 70px;
            border-radius: 4px;
            border: 1px solid var(--input);
            text-align: center;
            font-weight: 600;
            text-transform: uppercase;
            cursor: pointer;
        }

        .input-key:focus { outline: none; border-color: var(--ring); box-shadow: 0 0 0 1px var(--ring); }
        .input-key.error { border-color: var(--destructive); animation: shake 0.4s both; }

        .status-text { flex: 1; font-size: 13px; color: var(--muted-foreground); }
        .status-text b { color: var(--foreground); background: var(--secondary); padding: 2px 6px; border-radius: 4px; }

        @keyframes pulse-red {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); }
            70% { box-shadow: 0 0 0 6px rgba(239, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }

        @keyframes shake {
            10%, 90% { transform: translateX(-1px); }
            20%, 80% { transform: translateX(2px); }
            30%, 50%, 70% { transform: translateX(-4px); }
            40%, 60% { transform: translateX(4px); }
        }

        .empty-state { text-align: center; padding: 30px; color: var(--muted-foreground); border: 1px dashed var(--border); border-radius: var(--radius); font-size: 14px; }
        .icon { width: 16px; height: 16px; stroke-width: 2; }
    </style>
</head>
<body>

    <div class="card">
        <div class="card-header">
            <h1 class="card-title">SoundKey</h1>
            <p class="card-description">点击录音并绑定按键。按下按键即可直接播放声音。</p>
        </div>
        <div class="card-content">
            <button class="btn btn-primary" onclick="addItem()" style="width: 100%; margin-bottom: 8px;">
                + 添加新录音
            </button>

            <ul id="list-container">
                <li class="empty-state" id="empty-msg">暂无音效，请先添加</li>
            </ul>
        </div>
    </div>

    <script>
        let soundItems = [];
        let uniqueIdCounter = 0;

        const ICONS = {
            mic: `<svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path><path d="M19 10v2a7 7 0 0 1-14 0v-2"></path><line x1="12" y1="19" x2="12" y2="23"></line><line x1="8" y1="23" x2="16" y2="23"></line></svg>`,
            stop: `<svg class="icon" viewBox="0 0 24 24" fill="currentColor"><rect x="6" y="6" width="12" height="12"></rect></svg>`,
            trash: `<svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"></path><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"></path><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"></path></svg>`
        };

        // 全局键盘监听 - 仅监听按下
        window.addEventListener('keydown', (e) => {
            if (e.repeat || document.activeElement.tagName === 'INPUT') return;
            const item = soundItems.find(i => i.key === e.key.toLowerCase());
            if (item && item.audioObj) playAudio(item);
        });

        function playAudio(item) {
            // 点击即播放逻辑：如果正在播放，重置到开头重新播放
            item.audioObj.pause();
            item.audioObj.currentTime = 0;
            
            // 界面反馈
            item.element.classList.add('active-playing');
            
            item.audioObj.play().catch(console.error);

            // 当音频播放结束时，移除高亮类
            item.audioObj.onended = () => {
                item.element.classList.remove('active-playing');
            };
        }

        function addItem() {
            document.getElementById('empty-msg').style.display = 'none';
            const list = document.getElementById('list-container');
            const id = uniqueIdCounter++;
            
            const li = document.createElement('li');
            li.className = 'sound-item';
            li.id = `item-${id}`;
            li.innerHTML = `
                <button class="btn btn-outline btn-record" id="btn-${id}">${ICONS.mic}</button>
                <span class="status-text" id="status-${id}">未录制</span>
                <input type="text" class="input-key" id="input-${id}" placeholder="KEY" readonly>
                <button class="btn btn-ghost" onclick="deleteItem(${id})" style="padding:0; width:32px;">${ICONS.trash}</button>
            `;
            list.appendChild(li);

            const itemData = { id, key: null, audioObj: null, element: li, chunks: [], mediaRecorder: null };
            soundItems.push(itemData);

            const recordBtn = document.getElementById(`btn-${id}`);
            const keyInput = document.getElementById(`input-${id}`);
            const statusText = document.getElementById(`status-${id}`);

            recordBtn.onclick = () => toggleRecording(itemData, recordBtn, statusText);

            keyInput.onfocus = () => {
                keyInput.value = '';
                statusText.innerText = '等待按键...';
            };

            keyInput.onkeydown = (e) => {
                e.preventDefault();
                const keyName = e.key;
                if (['Escape', 'Tab', 'Shift', 'Control', 'Alt'].includes(keyName)) return;

                const lowerKey = keyName.toLowerCase();
                const conflict = soundItems.find(i => i.key === lowerKey && i.id !== id);

                if (conflict) {
                    keyInput.classList.add('error');
                    statusText.innerText = `键 ${keyName.toUpperCase()} 已占用`;
                    setTimeout(() => keyInput.classList.remove('error'), 400);
                } else {
                    itemData.key = lowerKey;
                    keyInput.value = keyName.toUpperCase();
                    statusText.innerHTML = `已绑定: <b>${keyName.toUpperCase()}</b>`;
                    keyInput.blur();
                }
            };
        }

        async function toggleRecording(item, btn, status) {
            if (item.mediaRecorder && item.mediaRecorder.state === 'recording') {
                item.mediaRecorder.stop();
                return;
            }

            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                item.mediaRecorder = new MediaRecorder(stream);
                item.chunks = [];

                item.mediaRecorder.onstart = () => {
                    btn.classList.add('recording');
                    btn.innerHTML = ICONS.stop;
                    status.innerText = "录音中...";
                };

                item.mediaRecorder.ondataavailable = (e) => item.chunks.push(e.data);

                item.mediaRecorder.onstop = () => {
                    const blob = new Blob(item.chunks, { type: 'audio/ogg; codecs=opus' });
                    item.audioObj = new Audio(window.URL.createObjectURL(blob));
                    btn.classList.remove('recording');
                    btn.classList.add('has-audio');
                    btn.innerHTML = ICONS.mic;
                    status.innerHTML = item.key ? `已绑定: <b>${item.key.toUpperCase()}</b>` : "录音完成，请绑定键";
                };

                item.mediaRecorder.start();
            } catch (err) {
                alert("请开启麦克风权限");
            }
        }

        function deleteItem(id) {
            const idx = soundItems.findIndex(i => i.id === id);
            if (idx > -1) {
                soundItems[idx].element.remove();
                soundItems.splice(idx, 1);
            }
            if (soundItems.length === 0) document.getElementById('empty-msg').style.display = 'block';
        }
    </script>
</body>
</html>